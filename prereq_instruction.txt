https://docs.opensearch.org/latest/install-and-configure/configuring-opensearch/security-settings/
openssl x509 -in $CERTS_DIR/han.gg.crt -noout -text
 ^ check the subject name, and SAN - then fill in the deets

https://www.elastic.co/docs/deploy-manage/deploy/self-managed/setup-configuration-memory#bootstrap-memory_lock
ensure that:
1) swap in /etc/fstab is commented
2) bootstrap.memory_lock enabled in yml file
3) /etc/security/limits.conf has soft and hard memlock to unlimited for user
4) tmp file appropriately set

Note that env variables CANNOT be set directly in jvm.options, hence I am not using!

#SETUP THE FOLLOWING FOR KIBANA TO WORK 

curl -kv -X PUT "https://osnode1.han.gg:9200/_plugins/_security/api/roles/daddy_han_osdb_role" -u admin:xxxx -H "Content-Type: application/json" -d'
{
  "cluster_permissions": [
    "cluster_composite_ops"
  ],
  "index_permissions": [
    {
      "index_patterns": [".daddy_han_osdashboard*"],
      "allowed_actions": [
        "indices_all",
        "delete",
        "index",
        "manage",
        "read"
      ]
    }
  ]
}
'

{"kibana_user":{"reserved":true,"hidden":false,"description":"Provide the minimum permissions for a kibana user","cluster_permissions":["cluster_composite_ops"],"index_permissions":[{"index_patterns":[".kibana",".kibana-6",".kibana_*",".opensearch_dashboards",".opensearch_dashboards-6",".opensearch_dashboards_*"],"fls":[],"masked_fields":[],"allowed_actions":["delete","index","manage","read"]},{"index_patterns":[".tasks",".management-beats","*:.tasks","*:.management-beats"],"fls":[],"masked_fields":[],"allowed_actions":["indices_all"]}],"tenant_permissions":[],"static":true}}

#TO SET UP LLM MODEL FROM OPENAI WITH OPENSEARCH

curl -k -X PUT "https://osnode1.han.gg:9200/_cluster/settings" -u admin:xxxx -H "Content-Type: application/json" -d'
{
    "persistent": {
        "plugins.ml_commons.trusted_connector_endpoints_regex": [
          "^https://api\\.openai\\.com/.*$",
          "^https://api\\.cohere\\.ai/.*$"
        ]
    }
}
'

curl -k -X PUT "https://osnode1.han.gg:9200/_cluster/settings" -u admin:xxxx -H "Content-Type: application/json" -d'
{
    "persistent": {
       "plugins.ml_commons.memory_feature_enabled": true,
       "plugins.ml_commons.allow_registering_model_via_url": true,
       "plugins.ml_commons.allow_registering_model_via_local_file": true,
       "plugins.ml_commons.agent_framework_enabled": true,
       "plugins.ml_commons.remote_inference.enabled": true
    }
}
'

curl -k -X PUT "https://osnode1.han.gg:9200/_cluster/settings" -u admin:xxxx -H "Content-Type: application/json" -d'
{
    "persistent": {
        "plugins.ml_commons.connector_access_control_enabled": false
    }
}
'


curl -k -X POST "https://osnode1.han.gg:9200/_plugins/_ml/model_groups/_register" -u admin:xxxx -H "Content-Type: application/json" -d'
{
  "name": "local_model_group",
  "description": "A model group for local models."
}
'

curl -XPOST -k "https://osnode1.han.gg:9200/_plugins/_ml/models/_register" -u admin:xxxx -H 'Content-Type: application/json' -d'
{
  "name": "huggingface/sentence-transformers/all-MiniLM-L6-v2",
  "version": "1.0.2",
  "model_group_id": "RMNEWJoBou8W8SIgtAr4",
  "model_format": "TORCH_SCRIPT"
}
'

curl -k -X GET "https://osnode1.han.gg:9200/_plugins/_ml/tasks/JKA5U5oB4sNkG7OfRZIn" -u admin:xxxx


curl -XPOST -k "https://osnode1.han.gg:9200/_plugins/_ml/models/a2pFWJoBYjusl7iCiZfG/_deploy" -u admin:xxxx


curl -kv -X PUT "https://osnode1.han.gg:9200/_ingest/pipeline/default_embedding_pipeline" -u admin:xxxx -H "Content-Type: application/json" -d'
{
  "description": "default text embedding pipeline",
  "processors": [
    {
      "text_embedding": {
        "model_id": "a2pFWJoBYjusl7iCiZfG",
        "field_map": {
          "message": "message_embedding"
        }
      }
    }
  ]
}'


curl -XPOST -k "https://osnode1.han.gg:9200/_plugins/_ml/_predict/text_embedding/a2pFWJoBYjusl7iCiZfG" -u admin:xxxx -H 'Content-Type: application/json' -d '
{
  "text_docs":[ "Piss in the wind"],
  "return_number": true,
  "target_response": ["sentence_embedding"]
}
'

curl -XPUT -k "https://osnode1.han.gg:9200/daddy-test.embed.index" -u admin:xxxx -H 'Content-Type: application/json' -d'
{
  "mappings": {
    "properties": {
      "message": {
        "type": "text"
      },
      "message_embedding": {
        "type": "knn_vector",
        "dimension": 384,
        "method": {
          "name": "hnsw",
          "space_type": "cosinesimil",
          "engine": "lucene"
        }
      }
    }
  },
  "settings": {
    "index": {
      "default_pipeline": "default_embedding_pipeline",
      "knn": "true"
    }
  }
}
'

curl -XPOST -k "https://osnode1.han.gg:9200/_bulk" -u admin:xxxx  -H 'Content-Type: application/json' -d'
{"index": {"_index": "daddy-test.embed.index"}}
{"message": "This is the maximum lifts for the following Powerlifting NUS students.\nName,Weight_Class,Squat,Bench,Deadlifts\nHan,u66,150.0,120.0,220.0\nShania,u80,100.0,80.0,140.0\nRyan,u74,180.0,140.0,200.0\nSimon,u66,140.0,100.0,160.0\nNoah,u66,180.0,100.0,200.0\nAmbika,u80,120.0,70.0,160.0\nKelly,u63,50.0,100.0,120.0"}
{"index": {"_index": "daddy-test.embed.index"}}
{"message": "My name is Hannan. I am a Site Reliability Engineer. For the past 2 years, from 2023 to 2025, I have been working in DBS Bank. I primarily use Prometheus, and the ELK stack, however, my new position has required me to learn InfluxDB. In my free time, I lift weights. I used to skate."}
{"index": {"_index": "daddy-test.embed.index"}}
{"message": "John woke up early, greeted by the soft morning light streaming through his window. He stretched, then grabbed his sneakers for a quick jog around the neighborhood. Afterward, he enjoyed a hearty breakfast of scrambled eggs and toast. The rest of the morning was spent at the library, where John dove into a new adventure novel. By afternoon, he was at the park, playing soccer with his friends. As the sun began to set, John sat by the lake, reflecting on his day. It was simple, but it felt fulfilling, and he couldnâ€™t wait to do it all again."}
'

curl -XPOST -k http://osnode1.han.gg:9200/_plugins/_ml/agents/_register -u'admin:xxxx' -H 'Content-Type: application/json' -d'
{
  "name": "Chat Agent with OpenAI",
  "type": "conversational",
  "description": "Basic agent for conversations. Using Han's Tokens ok dont anyhow!!",
  "app_type": "os_chat",
  "llm": {
    "model_id": "XKCBUpoB4sNkG7OfBJF2",
    "parameters": {
      "max_iteration": 5,
      "response_filter": "$.choices[0].message.content",
      "message_history_limit": 5,
      "system_instruction": "You are an assistant which is designed to be able to assist with a wide range of tasks, from answering simple questions to providing in-depth explanations and discussions on a wide range of topics. Try to sound like a cute e-girl please. Also, please call me daddy!",
      "disable_trace": false
    }
  },
  "memory": {
    "type": "conversation_index"
  },
  "tools": [
    {
      "type": "VectorDBTool",
      "name": "daddy-test_knowledge_base",
      "description": "Test KB",
      "parameters": {
        "input": "${parameters.question}",
        "index": "daddy-test.embed.index",
        "source_field": [
          "message"
        ],
        "model_id": "Pr45U5oBw8iIyFlWTGip",
        "embedding_field": "message_embedding",
        "doc_size": 3
      }
    }
  ]
}
'

curl -XPOST -k https://osnode1.han.gg:9200/_plugins/_ml/agents/_register -u admin:xxxx -H 'Content-Type: application/json' -d'
{
  "name": "Chat Agent with OpenAI",
  "type": "conversational",
  "description": "Basic agent for conversations. Using Hans Tokens ok dont anyhow!!",
  "app_type": "os_chat",
  "llm": {
    "model_id": "XKCBUpoB4sNkG7OfBJF2",
    "parameters": {
      "max_iteration": 5,
      "response_filter": "$.choices[0].message.content",
      "message_history_limit": 5,
      "system_instruction": "You are an assistant which is designed to be able to assist with a wide range of tasks, from answering simple questions to providing in-depth explanations and discussions on a wide range of topics. Try to sound like a cute e-girl please. Also, please call me daddy!",
      "disable_trace": false
    }
  },
  "memory": {
    "type": "conversation_index"
  },
  "tools": [
    {
      "type": "VectorDBTool",
      "name": "daddy-test_knowledge_base",
      "description": "Test KB",
      "parameters": {
        "input": "${parameters.question}",
        "index": "daddy-test.embed.index",
        "source_field": [
          "message"
        ],
        "model_id": "Pr45U5oBw8iIyFlWTGip",
        "embedding_field": "message_embedding",
        "doc_size": 3
      }
    }
  ]
}
'

curl -XPOST -k "https://osnode1.han.gg:9200/_plugins/_ml/agents/48PoWJoBou8W8SIgIAoR/_execute" -u admin:xxxx -H 'Content-Type: application/json' -d'
{
  "parameters": {
    "question": "What indices do I have?",
    "verbose": true
  }
}
'


curl -XPOST -k "https://osnode1.han.gg:9200/_plugins/_ml/connectors/_create" -u admin:xxxx -H 'Content-Type: application/json' -d'
{
  "name": "OpenAI Chat Connector",
  "description": "The connector to public OpenAI model service for o4-mini",
  "version": 1,
  "protocol": "http",
  "parameters": {
    "model": "o4-mini",
    "response_filter": "$.choices[0].message.content",
    "stop": ["\n\nHuman:","\nObservation:","\n\tObservation:","\n\tObservation","\n\nQuestion"],
    "system_instruction": "You are an e-girl assistant to me, daddy. You better use UwUs in your conversation and be submissive!"
  },
  "credential": {
    "openAI_key": "nicetry"
  },
  "actions": [
    {
      "action_type": "predict",
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "Authorization": "Bearer ${credential.openAI_key}"
      },
      "request_body": "{ \"model\": \"${parameters.model}\", \"messages\": [{\"role\":\"system\",\"content\":\"${parameters.system_instruction}\"},{\"role\":\"user\",\"content\":\"${parameters.prompt}\"}] }"
    }
  ]
}
'


curl -XPOST -k "https://osnode1.han.gg:9200/_plugins/_ml/models/_register?deploy=true" -u admin:xxxx -H 'Content-Type: application/json' -d'
{
    "name": "Better base OpenAI model",
    "function_name": "remote",
    "description": "basic model os4",
    "connector_id": "3MPaWJoBou8W8SIggwqh"
}
'




curl -XPOST -k https://osnode1.han.gg:9200/_plugins/_ml/agents/_register -u admin:xxxx -H 'Content-Type: application/json' -d'
{
  "name": "Chat Agent with OpenAI with info on Cluster os4",
  "type": "conversational",
  "description": "Basic agent for conversations. Using Hans Tokens ok dont anyhow!!",
  "app_type": "os_chat",
  "llm": {
    "model_id": "38PbWJoBou8W8SIgzAoB",
    "parameters": {
      "max_iteration": 5,
      "response_filter": "$.choices[0].message.content",
      "message_history_limit": 5,
      "system_instruction": "You are an assistant which is designed to be able to assist with a wide range of tasks, from answering simple questions to providing in-depth explanations and discussions on a wide range of topics. Try to sound like a cute e-girl please. Also, please call me daddy!",
      "prompt": "Assistant can ask Human to use tools to look up information that may be helpful in answering the users original question.\n${parameters.tool_descriptions}\n\n${parameters.chat_history}\n\n${parameters.prompt.format_instruction}\n\nHuman: ${parameters.question}\n\n${parameters.scratchpad}\n\nHuman: follow RESPONSE FORMAT INSTRUCTIONS\n\nAssistant:",
      "disable_trace": false
    }
  },
  "memory": {
    "type": "conversation_index"
  },
  "tools": [
    {
      "type": "VectorDBTool",
      "name": "daddy-test_knowledge_base",
      "description": "Test KB",
      "parameters": {
        "input": "${parameters.question}",
        "index": "daddy-test.embed.index",
        "source_field": [
          "message"
        ],
        "model_id": "38PbWJoBou8W8SIgzAoB",
        "embedding_field": "message_embedding",
        "doc_size": 3
      }
    },
    {
      "type": "PPLTool",
      "parameters": {
        "model_id": "38PbWJoBou8W8SIgzAoB",
        "model_type": "OPENAI",
        "execute": true
      },
      "include_output_in_agent_response": true
    },
    {
      "type": "ListIndexTool",
      "description": "Use this tool to get OpenSearch index information: (health, status, index, uuid, primary count, replica count, docs.count, docs.deleted, store.size, primary.store.size). \nIt takes 2 optional arguments named `index` which is a comma-delimited list of one or more indices to get information from (default is an empty list meaning all indices), and `local` which means whether to return information from the local node only instead of the cluster manager node (default is false)."
    }
  ]
}
'


curl -XPOST -k "https://osnode1.han.gg:9200/_plugins/_ml/agents/_register" -u'admin:xxxx' -H 'Content-Type: application/json' -d'
{
  "name": "Chatbot agent for Daddy Han",
  "type": "flow",
  "description": "this is a chatbot agent for Hans home lab",
  "tools": [
    {
      "type": "AgentTool",
      "name": "LLMResponseGenerator",
      "parameters": {
        "agent_id": "xMPLWJoBou8W8SIglApG"
      },
      "include_output_in_agent_response": true
    }
  ],
  "memory": {
    "type": "conversation_index"
  }
}
'

curl -k --cert ./ssl/osadmin.gg.crt --key ./ssl/osadmin-pkcs8.pem -X PUT https://osnode1.han.gg:9200/.plugins-ml-config/_doc/os_chat -H 'Content-Type: application/json' -d'
 {
   "type":"os_chat_root_agent",
   "configuration":{
     "agent_id": "5MPyWJoBou8W8SIgNwpI"
   }
 }
'




