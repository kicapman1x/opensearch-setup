https://docs.opensearch.org/latest/install-and-configure/configuring-opensearch/security-settings/
openssl x509 -in $CERTS_DIR/han.gg.crt -noout -text
 ^ check the subject name, and SAN - then fill in the deets

https://www.elastic.co/docs/deploy-manage/deploy/self-managed/setup-configuration-memory#bootstrap-memory_lock
ensure that:
1) swap in /etc/fstab is commented
2) bootstrap.memory_lock enabled in yml file
3) /etc/security/limits.conf has soft and hard memlock to unlimited for user
4) tmp file appropriately set

Note that env variables CANNOT be set directly in jvm.options, hence I am not using!

#SETUP THE FOLLOWING FOR KIBANA TO WORK 

curl -kv -X PUT "https://osnode1.han.gg:9200/_plugins/_security/api/roles/daddy_han_osdb_reader" -u admin:xxxx -H "Content-Type: application/json" -d'
{
  "cluster_permissions": [
    "cluster:monitor/health"
  ],
  "index_permissions": [
    {
      "index_patterns": [".daddy_han_osdashboard_config*"],
      "allowed_actions": [
        "indices:admin/get",
        "indices:data/read",
        "indices:monitor",
        "indices:admin/create",
        "indices:admin/refresh"
      ]
    }
  ]
}
'

#TO SET UP LLM MODEL FROM OPENAI WITH OPENSEARCH

curl -k -X PUT "https://osnode1.han.gg:9200/_cluster/settings" -u admin:password -H "Content-Type: application/json" -d'
{
    "persistent": {
        "plugins.ml_commons.trusted_connector_endpoints_regex": [
          "^https://api\\.openai\\.com/.*$",
          "^https://api\\.cohere\\.ai/.*$"
        ]
    }
}
'

curl -k -X PUT "https://osnode1.han.gg:9200/_cluster/settings" -u admin:password -H "Content-Type: application/json" -d'
{
    "persistent": {
        "plugins.ml_commons.connector_access_control_enabled": true
    }
}
'

curl -k -X POST "https://osnode1.han.gg:9200/_plugins/_ml/model_groups/_register" -u admin:password -H "Content-Type: application/json" -d'
{
  "name": "openai_model_group",
  "description": "A model group for external openai models. Daddy abit too poor to host his own local one, no GPU. Pls paynow me if you want 2 fund my homelab journey"
}
'

curl -k -X POST "https://osnode1.han.gg:9200/_plugins/_ml/connectors/_create" -u admin:password -H "Content-Type: application/json" -d'
{
    "name": "OpenAI Chat Connector",
    "description": "The connector to public OpenAI model service for GPT 3.5",
    "version": 1,
    "protocol": "http",
    "parameters": {
        "endpoint": "api.openai.com",
        "model": "gpt-3.5-turbo"
    },
    "credential": {
        "openAI_key": "***"
    },
    "actions": [
        {
            "action_type": "predict",
            "method": "POST",
            "url": "https://${parameters.endpoint}/v1/chat/completions",
            "headers": {
                "Authorization": "Bearer ${credential.openAI_key}"
            },
            "request_body": "{ \"model\": \"${parameters.model}\", \"messages\": ${parameters.messages} }"
        }
    ]
}
'

curl -k -X POST "https://osnode1.han.gg:9200/_plugins/_ml/models/_register" -u admin:password -H "Content-Type: application/json" -d'
{
    "name": "openAI-gpt-3.5-turbo",
    "function_name": "remote",
    "model_group_id": "UKBaUpoB4sNkG7OfQ5Em",
    "description": "basic llm model",
    "connector_id": "VKBmUpoB4sNkG7OfkpFi"
}
'

curl -k -X GET "https://osnode1.han.gg:9200/_plugins/_ml/tasks/WKCBUpoB4sNkG7OfA5Hv" -u admin:password 


curl -k -X POST "https://osnode1.han.gg:9200/_plugins/_ml/models/XKCBUpoB4sNkG7OfBJF2/_predict" -u admin:password -H "Content-Type: application/json" -d'
{
  "parameters": {
    "messages": [
      {
        "role": "system",
        "content": "You are a helpful assistant for an OpenSearch cluster."
      },
      {
        "role": "user",
        "content": "Hello!"
      }
    ]
  }
}
'